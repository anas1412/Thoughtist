<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thoughtist // Spatial Thinking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        :root { --accent: #6366f1; --bg: #020408; }
        
        body { 
            overflow: hidden; background: var(--bg); color: #e2e8f0; 
            font-family: 'Plus Jakarta Sans', sans-serif; width: 100vw; height: 100vh;
            background: radial-gradient(circle at 50% 50%, #0f172a 0%, #020408 100%);
        }

        #viewport { position: absolute; inset: 0; z-index: 10; overflow: hidden; pointer-events: none; }
        #world { position: absolute; transform-origin: 0 0; will-change: transform; pointer-events: none; width: 100%; height: 100%; }
        
        .thought-bulb { position: absolute; user-select: none; touch-action: none; will-change: transform; z-index: 20; width: 280px; pointer-events: auto; }
        .thought-bulb-content {
            background: rgba(15, 23, 42, 0.96); backdrop-filter: blur(20px); border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5); padding: 24px; border-radius: 32px;
        }
        .thought-bulb.dragging .thought-bulb-content { border-color: var(--accent); box-shadow: 0 0 40px rgba(99, 102, 241, 0.4); }

        .markdown-body { font-size: 11px; line-height: 1.5; color: rgba(255,255,255,0.7); }
        .markdown-body strong { color: white; }

        /* Empty State Guide */
        #empty-guide { position: fixed; inset: 0; z-index: 5; pointer-events: none; opacity: 0; transition: opacity 0.5s ease-in-out; display: flex; align-items: center; justify-content: center; }
        .chalk-path { stroke: rgba(255, 255, 255, 0.15); stroke-width: 2; fill: none; stroke-linecap: round; stroke-dasharray: 800; stroke-dashoffset: 0; animation: draw 2s ease-out forwards; }
        @keyframes draw { from { stroke-dashoffset: 800; } to { stroke-dashoffset: 0; } }

        /* Kanban Visuals */
        .kanban-overlay { position: fixed; inset: 0; display: flex; pointer-events: none; opacity: 0; transition: opacity 0.4s; z-index: 50; }
        body.view-kanban .kanban-overlay { opacity: 1; }
        .col-section { flex: 1; border-right: 1px dashed rgba(255,255,255,0.05); }
        .col-header-box { 
            height: 60px; margin-top: 140px; display: flex; align-items: center; justify-content: center;
            background: rgba(2, 4, 8, 0.85); backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .col-label { font-size: 11px; font-weight: 900; color: var(--accent); letter-spacing: 0.4em; text-transform: uppercase; }

        /* Calendar Visuals */
        .calendar-overlay { position: fixed; inset: 0; display: flex; pointer-events: none; opacity: 0; transition: opacity 0.4s; z-index: 5; padding: 100px 40px 40px 40px; gap: 20px; }
        body.view-calendar .calendar-overlay { opacity: 1; pointer-events: auto; }
        
        .cal-sidebar { width: 260px; background: rgba(2, 4, 8, 0.6); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; display: flex; flex-direction: column; overflow: hidden; backdrop-filter: blur(10px); }
        .cal-sidebar-header { padding: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 10px; font-weight: 900; letter-spacing: 0.2em; text-transform: uppercase; color: var(--accent); }
        
        .cal-main { flex: 1; display: flex; flex-direction: column; background: rgba(2, 4, 8, 0.6); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; backdrop-filter: blur(10px); overflow: hidden; }
        .cal-header { height: 60px; display: flex; align-items: center; justify-content: space-between; padding: 0 30px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .cal-title { font-size: 16px; font-weight: 700; color: white; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); grid-template-rows: 30px repeat(5, 1fr); height: 100%; }
        
        .cal-day-label { display: flex; align-items: center; justify-content: center; font-size: 9px; font-weight: 800; color: rgba(255,255,255,0.4); text-transform: uppercase; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .cal-cell { border-right: 1px solid rgba(255,255,255,0.05); border-bottom: 1px solid rgba(255,255,255,0.05); position: relative; transition: 0.2s; }
        .cal-cell:hover { background: rgba(255,255,255,0.02); }
        .cal-cell.today { background: rgba(99, 102, 241, 0.05); }
        .cal-date-num { position: absolute; top: 8px; right: 8px; font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.3); }
        .cal-cell.today .cal-date-num { color: var(--accent); }

        /* Paint Refinements for Calendar */
        body.view-calendar .paint-container { background: transparent !important; border: none !important; padding: 0 !important; }
        body.view-calendar .paint-container img { max-height: 80px !important; }

        .ui-layer { z-index: 9999; position: fixed; pointer-events: auto; }
        .glass { background: rgba(10, 10, 15, 0.85); backdrop-filter: blur(24px); border: 1px solid rgba(255, 255, 255, 0.08); }
        
        .custom-scroll::-webkit-scrollbar { width: 4px; height: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.1); border-radius: 10px; }

        .tag-pill { font-size: 9px; font-weight: 700; padding: 3px 10px; border-radius: 8px; display: inline-flex; align-items: center; gap: 6px; border: 1px solid rgba(255,255,255,0.1); white-space: nowrap; }
        .checkbox { width: 18px; height: 18px; border: 2px solid rgba(255,255,255,0.1); border-radius: 6px; flex-shrink: 0; position: relative; cursor: pointer; transition: 0.2s; }
        .checkbox.checked { background: var(--accent); border-color: var(--accent); }
        .checkbox.checked::after { content: 'âœ“'; position: absolute; font-size: 12px; left: 3px; top: -1px; color: white; }

        .thought-table { border-collapse: collapse; width: 100%; font-size: 10px; table-layout: fixed; }
        .thought-table td { border: 1px solid rgba(255,255,255,0.1); padding: 6px; background: rgba(255,255,255,0.02); }
        #paint-canvas { background: #000; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); cursor: crosshair; touch-action: none; }
        .type-btn { padding: 8px; border-radius: 12px; font-size: 9px; font-weight: 800; text-transform: uppercase; background: rgba(255,255,255,0.03); border: 1px solid transparent; transition: 0.2s; color: #475569; }
        .type-btn.active { background: rgba(99, 102, 241, 0.1); border-color: var(--accent); color: white; }
        .active-tab { background: var(--accent); color: white; box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.4); }
        #modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(10px); z-index: 10000; display: none; align-items: center; justify-content: center; }
        .modal-box { width: 420px; padding: 40px; border-radius: 40px; border: 1px solid rgba(255,255,255,0.1); }
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
    </style>
</head>
<body class="view-spatial">

    <div id="viewport">
        <div id="world">
            <canvas id="connection-canvas" style="position:absolute; inset:0; pointer-events:none; z-index:1;"></canvas>
        </div>
    </div>

    <div id="empty-guide">
        <!-- 0. Manage Spaces (Top Left) -->
        <div style="position: absolute; top: 110px; left: 100px; transform: rotate(5deg); text-align: center;">
            <svg width="40" height="60" viewBox="0 0 50 100" style="opacity: 0.5; display: block; margin: 0 auto; transform: scaleX(-1);">
                <path d="M 25 100 Q 25 50 25 10 M 10 30 L 25 10 L 40 30" stroke="white" stroke-width="2" fill="none" stroke-linecap="round" />
            </svg>
            <p style="font-family: 'Comic Sans MS', cursive; color: rgba(255,255,255,0.4); font-size: 12px; margin-top: 5px;">Manage Spaces</p>
        </div>

        <!-- 1. Switch Spaces (Top Center) -->
        <div style="position: absolute; top: 110px; left: 50%; transform: translateX(-50%) rotate(-2deg); text-align: center;">
            <svg width="40" height="60" viewBox="0 0 50 100" style="opacity: 0.5; display: block; margin: 0 auto;">
                <path d="M 25 100 Q 25 50 25 10 M 10 30 L 25 10 L 40 30" stroke="white" stroke-width="2" fill="none" stroke-linecap="round" />
            </svg>
            <p style="font-family: 'Comic Sans MS', cursive; color: rgba(255,255,255,0.4); font-size: 12px; margin-top: 5px;">Switch Spaces</p>
        </div>

        <!-- 2. Create Idea (Top Right - Inner) -->
        <div style="position: absolute; top: 110px; right: 230px; transform: rotate(5deg); text-align: center;">
            <svg width="40" height="60" viewBox="0 0 50 100" style="opacity: 0.5; display: block; margin: 0 auto; transform: rotate(15deg);">
                <path d="M 25 100 Q 25 50 25 10 M 10 30 L 25 10 L 40 30" stroke="white" stroke-width="2" fill="none" stroke-linecap="round" />
            </svg>
            <p style="font-family: 'Comic Sans MS', cursive; color: rgba(255,255,255,0.4); font-size: 12px; margin-top: 5px;">Create Idea</p>
        </div>

        <!-- 3. Change Perspective (Top Right - Outer) -->
        <div style="position: absolute; top: 110px; right: 50px; transform: rotate(-5deg); text-align: center;">
            <svg width="40" height="60" viewBox="0 0 50 100" style="opacity: 0.5; display: block; margin: 0 auto;">
                <path d="M 25 100 Q 25 50 25 10 M 10 30 L 25 10 L 40 30" stroke="white" stroke-width="2" fill="none" stroke-linecap="round" />
            </svg>
            <p style="font-family: 'Comic Sans MS', cursive; color: rgba(255,255,255,0.4); font-size: 12px; margin-top: 5px;">Change Perspective</p>
        </div>

        <!-- 4. Manage Data (Bottom Center) -->
        <div style="position: absolute; bottom: 110px; left: 50%; transform: translateX(-50%) rotate(2deg); text-align: center;">
            <p style="font-family: 'Comic Sans MS', cursive; color: rgba(255,255,255,0.4); font-size: 12px; margin-bottom: 5px;">Manage Data</p>
            <svg width="40" height="60" viewBox="0 0 50 100" style="opacity: 0.5; display: block; margin: 0 auto;">
                <path d="M 25 0 Q 25 50 25 90 M 10 70 L 25 90 L 40 70" stroke="white" stroke-width="2" fill="none" stroke-linecap="round" />
            </svg>
        </div>

        <!-- Center Text -->
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center;">
            <h2 style="font-family: 'Comic Sans MS', cursive; color: rgba(255,255,255,0.1); font-size: 32px; letter-spacing: 4px; font-weight: bold;">YOUR MIND IS EMPTY</h2>
            <p style="font-family: 'Comic Sans MS', cursive; color: rgba(255,255,255,0.1); font-size: 12px; margin-top: 10px;">(For now...)</p>
            
            <!-- Paste Hint -->
            <div style="margin-top: 40px; padding: 10px 20px; background: rgba(255,255,255,0.02); border: 1px dashed rgba(255,255,255,0.05); border-radius: 20px; display: inline-block;">
                <p style="font-family: 'Comic Sans MS', cursive; color: rgba(255,255,255,0.3); font-size: 11px; letter-spacing: 1px; text-transform: uppercase;">
                    <span style="background: rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; margin-right: 5px;">Ctrl + V</span> 
                    Paste text or images to spawn thoughts instantly
                </p>
            </div>
        </div>
    </div>

    <div class="kanban-overlay">
        <div class="col-section"><div class="col-header-box"><span class="col-label">Todo</span></div></div>
        <div class="col-section"><div class="col-header-box"><span class="col-label">Doing</span></div></div>
        <div class="col-section" style="border:none"><div class="col-header-box"><span class="col-label">Done</span></div></div>
    </div>

    <div class="calendar-overlay">
        <div class="cal-sidebar" id="cal-drop-sidebar">
            <div class="cal-sidebar-header">Unscheduled</div>
            <!-- Physics will stack unscheduled items here -->
        </div>
        <div class="cal-main">
            <div class="cal-header">
                <button onclick="changeMonth(-1)" class="p-2 hover:bg-white/5 rounded-lg text-slate-400"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                <span id="cal-month-title" class="cal-title">January 2026</span>
                <button onclick="changeMonth(1)" class="p-2 hover:bg-white/5 rounded-lg text-slate-400"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
            </div>
            <div class="cal-grid" id="cal-grid">
                <!-- JS Generated -->
            </div>
        </div>
    </div>

    <!-- UI: TOP -->
    <div class="ui-layer top-8 left-8 right-8 flex items-center justify-between pointer-events-none">
        <div class="pointer-events-auto flex items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold tracking-tighter text-white">Thoughtist</h1>
                <div class="flex items-center gap-2 mt-1">
                    <p id="proj-title" class="text-[10px] uppercase tracking-widest text-indigo-400 font-black truncate max-w-[120px]">Project</p>
                    <button onclick="toggleProjectMenu()" class="p-1 rounded-md bg-white/5 hover:bg-white/10 transition-colors"><i data-lucide="sliders-horizontal" class="w-3 h-3 text-white"></i></button>
                </div>
            </div>
            <div id="project-menu" class="glass p-2 rounded-2xl flex items-center gap-1 opacity-0 pointer-events-none transition-all">
                <button onclick="openProjectModal('rename')" class="p-2 hover:bg-white/5 rounded-xl text-slate-300"><i data-lucide="edit-3" class="w-3.5 h-3.5"></i></button>
                <button onclick="moveProject(-1)" class="p-2 hover:bg-white/5 rounded-xl text-slate-300"><i data-lucide="chevron-left" class="w-3.5 h-3.5"></i></button>
                <button onclick="moveProject(1)" class="p-2 hover:bg-white/5 rounded-xl text-slate-300"><i data-lucide="chevron-right" class="w-3.5 h-3.5"></i></button>
                <div class="w-[1px] h-4 bg-white/10 mx-1"></div>
                <button onclick="openProjectModal('delete')" class="p-2 hover:bg-red-500/10 rounded-xl transition-colors text-red-500"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
            </div>
        </div>
        <div id="project-tabs" class="flex items-center gap-2 p-1.5 bg-black/40 rounded-2xl border border-white/10 overflow-x-auto no-scrollbar max-w-[40%] pointer-events-auto"></div>
        <div class="flex gap-2 pointer-events-auto">
            <button onclick="addThought()" class="glass py-3 px-5 rounded-2xl flex items-center gap-3 hover:bg-white/5 transition-all">
                <i data-lucide="plus" class="w-4 h-4 text-indigo-400"></i><span class="text-xs font-bold uppercase tracking-wider">New Thought</span>
            </button>
            <button onclick="toggleView()" class="glass py-3 px-5 rounded-2xl flex items-center gap-3 hover:bg-white/5 transition-all">
                <i data-lucide="layout" class="w-4 h-4 text-purple-400"></i><span id="view-btn-text" class="text-xs font-bold uppercase tracking-wider">Kanban</span>
            </button>
        </div>
    </div>

    <!-- UI: INSPECTOR -->
    <div id="inspector" class="ui-layer top-[120px] right-8 w-80 glass rounded-[2.5rem] p-8 hidden shadow-2xl overflow-y-auto max-h-[70vh] custom-scroll">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-[10px] font-black uppercase tracking-widest text-white">Thought Editor</h3>
            <button onclick="closeInspector()" class="text-slate-500 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
        </div>
        <div class="grid grid-cols-5 gap-1 mb-6">
            <button onclick="changeType('text')" id="btn-text" class="type-btn">Text</button>
            <button onclick="changeType('tasks')" id="btn-tasks" class="type-btn">Tasks</button>
            <button onclick="changeType('paint')" id="btn-paint" class="type-btn">Paint</button>
            <button onclick="changeType('table')" id="btn-table" class="type-btn">Table</button>
            <button onclick="changeType('image')" id="btn-image" class="type-btn">Image</button>
        </div>
        <div class="space-y-5">
            <input type="text" id="edit-name" maxlength="30" class="w-full bg-black/40 border border-white/10 rounded-xl p-3 text-sm outline-none focus:border-indigo-500 text-white" placeholder="Name">
            <textarea id="edit-desc" rows="2" maxlength="150" class="w-full bg-black/40 border border-white/10 rounded-xl p-3 text-xs outline-none focus:border-indigo-500 text-white" placeholder="Description"></textarea>
            <input type="date" id="edit-date" class="w-full bg-black/40 border border-white/10 rounded-xl p-3 text-xs outline-none focus:border-indigo-500 text-white font-mono uppercase">
            
            <div id="type-specific-area" class="pt-4 border-t border-white/5">
                <div id="area-text" class="hidden"><textarea id="edit-content" rows="6" maxlength="500" class="w-full bg-black/40 border border-white/10 rounded-xl p-3 text-xs outline-none focus:border-indigo-500 text-white" placeholder="Markdown supported..."></textarea></div>
                <div id="area-tasks" class="hidden space-y-3"><div id="task-list"></div><button onclick="addTask()" class="w-full py-2 border border-dashed border-white/10 rounded-xl text-[10px] uppercase font-bold text-slate-500 hover:text-white">+ Add Task</button></div>
                <div id="area-paint" class="hidden space-y-3 text-center"><canvas id="paint-canvas" width="240" height="160"></canvas><button onclick="clearPaint()" class="text-[9px] uppercase font-bold text-red-500 hover:underline">Clear</button></div>
                <div id="area-table" class="hidden space-y-3">
                    <div id="table-editor" class="overflow-x-auto custom-scroll"></div>
                    <div class="grid grid-cols-2 gap-1">
                        <button onclick="addTableRow()" class="py-1.5 bg-white/5 rounded-lg text-[8px] font-bold uppercase">+ Row</button>
                        <button onclick="addTableCol()" class="py-1.5 bg-white/5 rounded-lg text-[8px] font-bold uppercase">+ Col</button>
                        <button onclick="removeTableRow(selectedThought ? selectedThought.table.length - 1 : 0)" class="py-1.5 bg-red-900/10 rounded-lg text-[8px] font-bold uppercase text-red-500">- Row</button>
                        <button onclick="removeTableCol()" class="py-1.5 bg-red-900/10 rounded-lg text-[8px] font-bold uppercase text-red-500">- Col</button>
                    </div>
                </div>
                <div id="area-image" class="hidden space-y-3">
                    <div class="border border-dashed border-white/10 rounded-xl p-4 text-center hover:bg-white/5 transition-colors cursor-pointer relative">
                        <input type="file" id="img-upload" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer" onchange="handleImageUpload(this)">
                        <i data-lucide="image" class="w-6 h-6 mx-auto text-slate-500 mb-2"></i>
                        <p class="text-[9px] text-slate-400 uppercase font-bold tracking-widest">Upload or Drag Image</p>
                    </div>
                    <div class="flex gap-2">
                        <input type="text" id="img-url" placeholder="Or paste image URL..." class="flex-1 bg-black/40 border border-white/10 rounded-xl p-2 text-xs outline-none focus:border-indigo-500 text-white">
                        <button onclick="handleImageUrl()" class="p-2 bg-white/5 rounded-xl hover:bg-white/10 text-white"><i data-lucide="link" class="w-4 h-4"></i></button>
                    </div>
                    <div id="img-preview" class="hidden rounded-xl border border-white/10 overflow-hidden bg-black/50">
                        <!-- Preview injected here -->
                    </div>
                </div>
            </div>
            <div class="tag-input-wrap" id="tag-container"><input type="text" id="tag-input" placeholder="Add tag..." class="bg-transparent outline-none text-white text-xs w-full"></div>
            <button onclick="openProjectModal('delete_node')" class="w-full bg-red-500/10 hover:bg-red-500/20 text-red-400 py-4 rounded-2xl text-[10px] font-bold uppercase tracking-widest transition-colors">Delete Thought</button>
        </div>
    </div>

    <!-- UI: MODAL -->
    <div id="modal-overlay">
        <div class="modal-box glass text-center">
            <h2 id="modal-title" class="text-xl font-bold mb-2 text-white"></h2>
            <p id="modal-desc" class="text-xs text-slate-400 mb-8 uppercase tracking-widest leading-relaxed"></p>
            <input type="text" id="modal-input" class="w-full bg-black/40 border border-white/10 rounded-xl p-4 text-sm outline-none mb-8 focus:border-indigo-500 text-white">
            <div class="flex gap-4">
                <button id="modal-cancel-btn" onclick="closeModal()" class="flex-1 py-4 text-xs font-bold uppercase tracking-widest bg-white/5 rounded-2xl text-white">Cancel</button>
                <button id="modal-confirm-btn" class="flex-1 py-4 text-xs font-bold uppercase tracking-widest bg-indigo-500 rounded-2xl text-white">Confirm</button>
            </div>
        </div>
    </div>

    <!-- UI: BOTTOM -->
    <div class="ui-layer bottom-8 left-1/2 -translate-x-1/2 glass px-8 py-4 rounded-full flex gap-8 items-center text-[10px] uppercase font-bold tracking-widest text-slate-500">
        <div class="flex items-center gap-3"><span class="w-2 h-2 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]"></span> <span class="text-white"><span id="node-count">0</span>/40 Thoughts</span></div>
        <div class="h-4 w-[1px] bg-white/10"></div>
        <button onclick="togglePhysics()" id="phys-btn" class="flex items-center gap-2 transition-all"><i data-lucide="zap" class="w-3.5 h-3.5"></i> <span id="phys-status">Physics On</span></button>
        <button onclick="exportData()" class="hover:text-white flex items-center gap-2 transition-colors"><i data-lucide="download" class="w-3.5 h-3.5"></i> Export</button>
        <label class="flex items-center gap-2 cursor-pointer hover:text-white"><i data-lucide="upload" class="w-3.5 h-3.5"></i> Import <input type="file" id="import-input" class="hidden" accept=".json"></label>
        <div class="h-4 w-[1px] bg-white/10"></div>
        <button onclick="openProjectModal('new')" class="text-indigo-400 hover:text-white transition-all">+ New Project (<span id="proj-slots">0</span>/8)</button>
    </div>

    <!-- UI: LIGHTBOX -->
    <div id="lightbox" class="fixed inset-0 z-[10000] bg-black/90 backdrop-filter backdrop-blur-xl hidden items-center justify-center p-8 cursor-zoom-out" onclick="closeLightbox()">
        <img id="lightbox-img" class="max-w-full max-h-full rounded-2xl shadow-2xl border border-white/10" src="" />
    </div>

    <script>
        const KEY = 'thoughtist_MASTER_ULTIMATE_STABLE_V900';
        let projects = JSON.parse(localStorage.getItem(KEY)) || [{ id: 'p1', name: 'General Space', nodes: [], mode: 'spatial', physics: true }];
        let activeProjectId = projects[0].id;
        let thoughts = [];
        let selectedThought = null;
        let transform = { x: 0, y: 0, scale: 1 };
        
        const viewport = document.getElementById('viewport'), world = document.getElementById('world'), canvas = document.getElementById('connection-canvas'), ctx = canvas.getContext('2d'), pCanvas = document.getElementById('paint-canvas'), pCtx = pCanvas.getContext('2d');
        const DAMPING = 0.88, REPULSION = 48000, ATTRACTION = 0.025, GRAVITY = 0.005;
        
        // Calendar State
        let calDate = new Date();
        let calCells = []; // Stores rects: {x, y, w, h, dateStr}

        class Thought {
            constructor(data) {
                this.id = data.id || Math.random();
                this.x = data.x || window.innerWidth / 2;
                this.y = data.y || window.innerHeight / 2;
                this.vx = 0; this.vy = 0;
                this.text = data.text || "";
                this.description = data.description || "";
                this.type = data.type || 'text';
                this.content = data.content || "";
                this.image = data.image || null;
                this.tags = data.tags || [];
                this.status = data.status || 'todo';
                this.tasks = data.tasks || [];
                this.table = data.table || [["", ""], ["", ""]];
                this.drawing = data.drawing || null;
                this.date = data.date || "";
                this.order = data.order || 0;
                this.isDragging = false;
                this.element = this.createDOM();
                this.updateDOM();
            }

            createDOM() {
                const div = document.createElement('div');
                div.className = 'thought-bulb';
                div.addEventListener('mousedown', (e) => this.onStart(e));
                div.addEventListener('click', (e) => { 
                    if (!e.target.closest('.checkbox') && !e.target.closest('.expand-img') && !this.isDragging) this.openInspector(); 
                });
                world.appendChild(div);
                return div;
            }

            updateDOM() {
                let inner = "";
                if (this.type === 'text' && this.content) inner = `<div class="markdown-body mt-1">${marked.parse(this.content)}</div>`;
                if (this.type === 'tasks' && this.tasks.length) {
                    const done = this.tasks.filter(t => t.done).length;
                    inner = `<div class="h-1.5 w-full bg-white/5 rounded-full overflow-hidden mt-1"><div class="h-full bg-indigo-500 transition-all duration-500" style="width:${(done/this.tasks.length)*100}%"></div></div>`;
                }
                if (this.type === 'paint' && this.drawing) inner = `<div class="paint-container bg-black/40 rounded-xl p-2 mt-1 border border-white/5"><img src="${this.drawing}" class="w-full rounded-lg object-contain" style="max-height: 140px;" /></div>`;
                if (this.type === 'table') inner = `<table class="thought-table mt-1">${this.table.slice(0, 4).map(r => `<tr>${r.slice(0, 2).map(c => `<td>${c}</td>`).join('')}</tr>`).join('')}</table>`;
                if (this.type === 'image' && this.image) inner = `<div class="mt-2 relative group"><img src="${this.image}" class="w-full rounded-xl border border-white/10 max-h-[160px] object-cover bg-black/50" /><button onclick="openLightbox('${this.image}')" class="expand-img absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center text-white"><i data-lucide="maximize-2"></i></button></div>`;

                this.element.innerHTML = `<div class="thought-bulb-content flex flex-col gap-3">${this.date ? `<div class="absolute top-4 right-4 text-[9px] font-mono text-indigo-400 border border-indigo-500/30 px-1.5 py-0.5 rounded bg-indigo-500/10">${this.date}</div>` : ''}${this.text ? `<p class="text-[13px] font-bold text-white pr-10">${this.text}</p>` : '<p class="text-[13px] font-bold text-slate-600 italic pr-10">Untitled</p>'}${this.description ? `<p class="text-[10px] text-slate-500 italic">${this.description}</p>` : ''}${inner}<div class="flex flex-wrap gap-1.5 mt-1">${this.tags.map(t => `<span class="tag-pill" style="${getTagStyle(t)}">${t}</span>`).join('')}</div></div>`;
                refreshIcons();
            }

            onStart(e) {
                if (e.button !== 0 || e.target.closest('.checkbox') || e.target.closest('.expand-img')) return;
                e.stopPropagation(); this.isDragging = true; this.element.classList.add('dragging');
                const startX = (e.clientX - transform.x) / transform.scale, startY = (e.clientY - transform.y) / transform.scale;
                const offX = startX - this.x, offY = startY - this.y;
                const move = (ev) => { this.x = (ev.clientX - transform.x) / transform.scale - offX; this.y = (ev.clientY - transform.y) / transform.scale - offY; };
                const up = (ev) => {
                    this.isDragging = false; this.element.classList.remove('dragging');
                    
                    if (document.body.classList.contains('view-kanban')) {
                        const wx = this.x;
                        if (wx < window.innerWidth * 0.33) this.status = 'todo'; else if (wx < window.innerWidth * 0.66) this.status = 'doing'; else this.status = 'done';
                        this.reorderColumn(this.status);
                    }
                    else if (document.body.classList.contains('view-calendar')) {
                        // Drag Drop Logic for Calendar
                        const mouseX = ev.clientX; const mouseY = ev.clientY;
                        
                        // Check Sidebar Drop
                        const sideRect = document.getElementById('cal-drop-sidebar').getBoundingClientRect();
                        if (mouseX >= sideRect.left && mouseX <= sideRect.right && mouseY >= sideRect.top && mouseY <= sideRect.bottom) {
                            this.date = ""; this.updateDOM();
                        } else {
                            // Check Cell Drop via Cached Rects (Robust against Z-Index)
                            const hit = calCells.find(c => mouseX >= c.left && mouseX <= c.right && mouseY >= c.top && mouseY <= c.bottom);
                            if (hit) {
                                this.date = hit.date;
                                this.updateDOM();
                            }
                        }
                    }

                    window.removeEventListener('mousemove', move); window.removeEventListener('mouseup', up); save();
                };
                window.addEventListener('mousemove', move); window.addEventListener('mouseup', up);
            }

            reorderColumn(status) { const col = thoughts.filter(n => n.status === status).sort((a,b) => a.y - b.y); col.forEach((n, i) => n.order = i); }
            openInspector() { 
                selectedThought = this; 
                document.getElementById('inspector').classList.remove('hidden'); 
                document.getElementById('edit-name').value = this.text; 
                document.getElementById('edit-desc').value = this.description; 
                document.getElementById('edit-content').value = this.content || ""; 
                document.getElementById('edit-date').value = this.date || "";
                this.renderTypeView(); this.renderTags(); 
            }
            
            renderTypeView() {
                document.querySelectorAll('.type-btn').forEach(b => b.classList.remove('active')); document.getElementById('btn-' + this.type).classList.add('active');
                ['text', 'tasks', 'paint', 'table', 'image'].forEach(t => document.getElementById('area-'+t).classList.add('hidden')); document.getElementById('area-' + this.type).classList.remove('hidden');
                if (this.type === 'tasks') this.renderTasks(); if (this.type === 'table') this.renderTableEditor();
                if (this.type === 'paint') { pCtx.clearRect(0,0,240,160); if (this.drawing) { const img = new Image(); img.onload = () => pCtx.drawImage(img,0,0); img.src = this.drawing; } }
                if (this.type === 'image') this.renderImageEditor();
            }

            renderImageEditor() {
                const preview = document.getElementById('img-preview');
                if (this.image) {
                    preview.innerHTML = `<img src="${this.image}" class="w-full object-contain" />`;
                    preview.classList.remove('hidden');
                } else {
                    preview.innerHTML = '';
                    preview.classList.add('hidden');
                }
            }

            renderTags() {
                const wrap = document.getElementById('tag-container'); wrap.querySelectorAll('.tag-pill').forEach(el => el.remove());
                this.tags.forEach((t, i) => { const span = document.createElement('span'); span.className = 'tag-pill'; span.style = getTagStyle(t); span.innerHTML = `${t} <i data-lucide="x" class="w-3 h-3 cursor-pointer" onclick="removeTag(${i})"></i>`; wrap.insertBefore(span, document.getElementById('tag-input')); });
                refreshIcons();
            }
            renderTasks() { document.getElementById('task-list').innerHTML = this.tasks.map((t, i) => `<div class="flex items-center gap-3"><div class="checkbox ${t.done ? 'checked' : ''}" onclick="toggleTask(${this.id}, ${i})"></div><input type="text" value="${t.text}" oninput="editTask(${i}, this.value)" class="flex-1 bg-black/20 border border-white/5 rounded-xl p-2 text-xs outline-none text-white focus:border-indigo-500"> <button onclick="removeTask(${i})" class="text-red-400 p-1"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button></div>`).join(''); refreshIcons(); }
            renderTableEditor() { 
                let html = `<table class="thought-table">`; 
                this.table.forEach((row, r) => { 
                    html += `<tr>`; 
                    row.forEach((cell, c) => { 
                        html += `<td><input type="text" value="${cell}" oninput="editTableCell(${r},${c},this.value)" class="w-full bg-transparent outline-none text-white text-[10px]"></td>`; 
                    }); 
                    html += `</tr>`; 
                }); 
                html += `</table>`; 
                document.getElementById('table-editor').innerHTML = html; 
            }
        }

        // Logic Actions
        function addThought(data = {}) { 
            if (thoughts.length >= 40) return openProjectModal('limit'); 
            const n = new Thought({ 
                x: (window.innerWidth/2 - transform.x)/transform.scale, 
                y: (window.innerHeight/2 - transform.y)/transform.scale, 
                order: thoughts.length,
                ...data
            }); 
            thoughts.push(n); updateStats(); save();
            setTimeout(() => n.openInspector(), 50); // Slight delay to ensure DOM is ready
        }
        function deleteThought() { thoughts = thoughts.filter(n => n.id !== selectedThought.id); selectedThought.element.remove(); closeInspector(); updateStats(); save(); }
        function changeType(t) { selectedThought.type = t; selectedThought.renderTypeView(); selectedThought.updateDOM(); save(); }
        function addTask() { if(selectedThought){ selectedThought.tasks.push({ text: "Task", done: false }); selectedThought.renderTasks(); selectedThought.updateDOM(); save(); }}
        function editTask(i,v) { selectedThought.tasks[i].text = v; save(); selectedThought.updateDOM(); }
        function toggleTask(id,i) { const n = thoughts.find(x => x.id === id); n.tasks[i].done = !n.tasks[i].done; n.updateDOM(); save(); if(selectedThought) selectedThought.renderTasks(); }
        function removeTask(i) { selectedThought.tasks.splice(i,1); selectedThought.renderTasks(); selectedThought.updateDOM(); save(); }
        function removeTag(i) { selectedThought.tags.splice(i,1); selectedThought.renderTags(); selectedThought.updateDOM(); save(); }
        function editTableCell(r,c,v) { selectedThought.table[r][c] = v; save(); selectedThought.updateDOM(); }
        function addTableRow() { selectedThought.table.push(new Array(selectedThought.table[0].length).fill("")); selectedThought.renderTableEditor(); selectedThought.updateDOM(); save(); }
        function addTableCol() { selectedThought.table.forEach(r => r.push("")); selectedThought.renderTableEditor(); selectedThought.updateDOM(); save(); }
        function removeTableCol() { if(selectedThought.table[0].length > 1) { selectedThought.table.forEach(r => r.pop()); selectedThought.renderTableEditor(); selectedThought.updateDOM(); save(); }}
        function removeTableRow() { if(selectedThought.table.length > 1) { selectedThought.table.splice(selectedThought.table.length-1, 1); selectedThought.renderTableEditor(); selectedThought.updateDOM(); save(); }}
        function getTagStyle(tag) { let h = 0; for(let i=0; i<tag.length; i++) h = tag.charCodeAt(i) + ((h<<5)-h); const hue = Math.abs(h * 137.5) % 360; return `background: hsla(${hue}, 70%, 50%, 0.15); color: hsla(${hue}, 90%, 75%, 1); border-color: hsla(${hue}, 70%, 50%, 0.3);`; }

        function loadProject(id) {
            thoughts.forEach(n => n.element.remove());
            activeProjectId = id; const p = projects.find(p => p.id === id);
            thoughts = (p.nodes || []).sort((a,b) => a.order - b.order).map(n => new Thought(n));
            document.body.className = 'view-' + p.mode;
            document.getElementById('view-btn-text').innerText = p.mode === 'spatial' ? 'Kanban' : (p.mode === 'kanban' ? 'Calendar' : 'Spatial');
            document.getElementById('proj-title').innerText = p.name;
            transform = { x: 0, y: 0, scale: 1 }; updateWorldTransform();
            updatePhysBtn(); renderTabs(); updateStats();
            document.getElementById('project-menu').classList.add('opacity-0');
            document.getElementById('project-menu').classList.add('pointer-events-none');
            refreshIcons();
            if(p.mode === 'calendar') renderCalendar();
            checkEmptyState();
        }

        function save() { 
            try {
                const p = projects.find(p => p.id === activeProjectId); 
                p.nodes = thoughts.map(n => ({ id: n.id, x: n.x, y: n.y, text: n.text, description: n.description, tags: n.tags, status: n.status, tasks: n.tasks, drawing: n.drawing, table: n.table, order: n.order, type: n.type, content: n.content, date: n.date, image: n.image })); 
                localStorage.setItem(KEY, JSON.stringify(projects)); 
            } catch (e) {
                if (e.name === 'QuotaExceededError' || e.name === 'NS_ERROR_DOM_QUOTA_REACHED') {
                    alert("Storage Limit Reached! Try removing some large images or sketches to save your progress.");
                } else {
                    console.error("Save Error:", e);
                }
            }
        }

        // Paste & Image Logic
        window.addEventListener('paste', (e) => {
            if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            let foundImage = false;
            
            for (let index in items) {
                const item = items[index];
                if (item.kind === 'file' && item.type.startsWith('image/')) {
                    foundImage = true;
                    const blob = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = (event) => { addThought({ type: 'image', image: event.target.result, text: "Image" }); };
                    reader.readAsDataURL(blob);
                    break; // Stop after finding an image
                }
            }

            if (!foundImage) {
                // Check for text only if no image was found
                for (let index in items) {
                    const item = items[index];
                    if (item.kind === 'string' && item.type === 'text/plain') {
                        item.getAsString((s) => { 
                            if(s) {
                                // Smart Title: First 20 chars or "Note"
                                const title = s.length < 20 ? s : "Note";
                                addThought({ type: 'text', text: title, content: s }); 
                            }
                        });
                        break; // Stop after handling text
                    }
                }
            }
        });

        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    selectedThought.image = e.target.result;
                    selectedThought.updateDOM();
                    selectedThought.renderImageEditor();
                    save();
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function handleImageUrl() {
            const url = document.getElementById('img-url').value;
            if(url) {
                selectedThought.image = url;
                selectedThought.updateDOM();
                selectedThought.renderImageEditor();
                save();
            }
        }

        function openLightbox(src) { document.getElementById('lightbox-img').src = src; document.getElementById('lightbox').classList.remove('hidden'); document.getElementById('lightbox').classList.add('flex'); }
        function closeLightbox() { document.getElementById('lightbox').classList.add('hidden'); document.getElementById('lightbox').classList.remove('flex'); }

        // Keyboard Shortcuts
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Delete') {
                // Don't delete if user is typing in an input or textarea
                if (['INPUT', 'TEXTAREA'].includes(document.activeElement.tagName)) return;
                if (selectedThought) {
                    openProjectModal('delete_node');
                }
            }
        });

        // Calendar Logic
        function changeMonth(dir) { calDate.setMonth(calDate.getMonth() + dir); renderCalendar(); }
        function renderCalendar() {
            const grid = document.getElementById('cal-grid');
            grid.innerHTML = "";
            const y = calDate.getFullYear(), m = calDate.getMonth();
            document.getElementById('cal-month-title').innerText = new Date(y, m).toLocaleString('default', { month: 'long', year: 'numeric' });
            
            // Labels
            ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].forEach(d => {
                const el = document.createElement('div'); el.className = 'cal-day-label'; el.innerText = d; grid.appendChild(el);
            });

            const firstDay = new Date(y, m, 1).getDay() || 7; // 1=Mon, 7=Sun
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            calCells = []; // Reset cell cache

            for (let i = 1; i < firstDay; i++) { grid.appendChild(document.createElement('div')); } // Padding
            
            const todayStr = new Date().toISOString().split('T')[0];

            for (let d = 1; d <= daysInMonth; d++) {
                const cell = document.createElement('div');
                cell.className = 'cal-cell';
                
                // Format: YYYY-MM-DD (local)
                const dateObj = new Date(y, m, d);
                const dateStr = dateObj.toLocaleDateString('en-CA'); // YYYY-MM-DD
                
                cell.dataset.date = dateStr;
                if (dateStr === todayStr) cell.classList.add('today');
                
                cell.innerHTML = `<span class="cal-date-num">${d}</span>`;
                grid.appendChild(cell);
            }
            
            // Re-cache rects on next frame to ensure layout is done
            setTimeout(() => {
                const cells = document.querySelectorAll('.cal-cell');
                calCells = Array.from(cells).map(c => {
                    const r = c.getBoundingClientRect();
                    return { 
                        x: r.left + r.width/2, 
                        y: r.top + r.height/2, 
                        left: r.left, right: r.right, top: r.top, bottom: r.bottom,
                        date: c.dataset.date 
                    };
                });
            }, 100);
        }

        // Modal Logic Fixed
        function openProjectModal(type) {
            const overlay = document.getElementById('modal-overlay');
            const input = document.getElementById('modal-input');
            const btn = document.getElementById('modal-confirm-btn');
            const titleEl = document.getElementById('modal-title');
            const descEl = document.getElementById('modal-desc');
            const cancelBtn = document.getElementById('modal-cancel-btn');

            overlay.style.display = 'flex';
            input.style.display = 'block';
            cancelBtn.style.display = 'block';

            if (type === 'rename') {
                const curP = projects.find(x => x.id === activeProjectId);
                titleEl.innerText = "Rename Workspace"; input.value = curP.name;
                btn.onclick = () => { curP.name = input.value.substring(0, 15) || curP.name; save(); loadProject(activeProjectId); closeModal(); };
            } else if (type === 'new') {
                if (projects.length >= 8) return openProjectModal('limit_p');
                titleEl.innerText = "New Workspace"; input.value = "";
                btn.onclick = () => {
                    const id = 'p' + Date.now();
                    projects.push({ id, name: input.value.substring(0, 15) || "Unnamed", nodes: [], mode: 'spatial', physics: true });
                    save(); loadProject(id); closeModal();
                };
            } else if (type === 'delete') {
                if (projects.length <= 1) return openProjectModal('limit_min');
                titleEl.innerText = "Delete Space"; input.style.display = 'none';
                btn.onclick = () => { projects = projects.filter(x => x.id !== activeProjectId); activeProjectId = projects[0].id; save(); loadProject(activeProjectId); closeModal(); };
            } else if (type === 'delete_node') {
                titleEl.innerText = "Delete Thought?"; 
                descEl.innerText = "This action cannot be undone.";
                input.style.display = 'none';
                btn.onclick = () => { deleteThought(); closeModal(); };
            } else {
                titleEl.innerText = "Limit Reached"; input.style.display = 'none'; cancelBtn.style.display = 'none'; btn.onclick = closeModal;
            }
            refreshIcons();
        }

        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }

        // Interaction
        window.addEventListener('mousedown', (e) => { 
            if (document.body.classList.contains('view-spatial') && 
                !e.target.closest('button, input, textarea, .thought-bulb, #inspector') && 
                (e.button === 1 || (e.button === 0 && e.altKey))) { 
                isPanning = true; 
                lastMousePos = { x: e.clientX, y: e.clientY }; 
                e.preventDefault(); 
            } 
        });
        window.addEventListener('mousemove', (e) => { if (isPanning) { transform.x += (e.clientX - lastMousePos.x); transform.y += (e.clientY - lastMousePos.y); lastMousePos = { x: e.clientX, y: e.clientY }; updateWorldTransform(); } });
        window.addEventListener('mouseup', () => isPanning = false);
        
        window.addEventListener('click', (e) => {
            // Close inspector if clicking background (not on a thought, inspector, or UI)
            if (!e.target.closest('.thought-bulb, #inspector, .ui-layer, .modal-box, .glass, .expand-img')) {
                closeInspector();
            }
        });

        window.addEventListener('wheel', (e) => {
            if (e.target.closest('#inspector')) return; // Prevent workspace zoom when scrolling inspector
            if (document.body.classList.contains('view-kanban')) {
                transform.y -= e.deltaY; if(transform.y > 0) transform.y = 0; // CLAMP TOP
                transform.x = 0; transform.scale = 1;
            } else if (document.body.classList.contains('view-calendar')) {
                // No zoom in calendar
                transform.x = 0; transform.y = 0; transform.scale = 1;
            } else {
                const delta = -e.deltaY; const newScale = Math.min(Math.max(0.1, transform.scale + delta * 0.001), 2);
                const wx = (e.clientX - transform.x) / transform.scale, wy = (e.clientY - transform.y) / transform.scale;
                transform.scale = newScale; transform.x = e.clientX - wx * newScale; transform.y = e.clientY - wy * newScale;
            }
            updateWorldTransform();
        }, { passive: false });
        function updateWorldTransform() { world.style.transform = `translate(${transform.x}px, ${transform.y}px) scale(${transform.scale})`; }

        function loop() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            const p = projects.find(x => x.id === activeProjectId);
            const isKanban = document.body.classList.contains('view-kanban');
            const isCalendar = document.body.classList.contains('view-calendar');

            thoughts.forEach((n, i) => {
                // Initialize scale if missing
                if (typeof n.scale === 'undefined') n.scale = 1;
                let targetScale = 1;

                if (!n.isDragging) {
                    if (isKanban) {
                        let tx = window.innerWidth * 0.16; if (n.status === 'doing') tx = window.innerWidth * 0.5; if (n.status === 'done') tx = window.innerWidth * 0.84;
                        const col = thoughts.filter(x => x.status === n.status).sort((a,b) => a.order - b.order);
                        let ty = 280; for (let other of col) { if (other.id === n.id) break; ty += (other.element.offsetHeight || 120) + 24; }
                        n.x += (tx - n.x) * 0.15; n.y += (ty + ((n.element.offsetHeight || 120)/2) - n.y) * 0.15;
                    } 
                    else if (isCalendar) {
                        let tx = 0, ty = 0;

                        if (!n.date) {
                            // Sidebar Logic
                            const sb = document.getElementById('cal-drop-sidebar');
                            const sbRect = sb.getBoundingClientRect();
                            targetScale = 0.75;
                            
                            tx = sbRect.left + sbRect.width / 2;
                            
                            const unscheduled = thoughts.filter(x => !x.date).sort((a,b) => a.order - b.order);
                            const idx = unscheduled.findIndex(x => x.id === n.id);
                            
                            // Stack with slight overlap/gap
                            const h = (n.element.offsetHeight || 120) * targetScale;
                            ty = sbRect.top + 140 + (idx * (h + 20)); 
                        } else {
                            // Grid Logic
                            const target = calCells.find(c => c.date === n.date);
                            if (target) {
                                // Fit width dynamic scaling
                                const cellW = target.right - target.left;
                                targetScale = Math.min((cellW - 20) / 280, 0.45); // Max 0.45 to keep them sticker-like
                                
                                tx = target.x;
                                
                                const sameDay = thoughts.filter(x => x.date === n.date).sort((a,b) => a.order - b.order);
                                const idx = sameDay.findIndex(x => x.id === n.id);
                                
                                // "Deck of Cards" Stacking
                                // Start near top of cell + padding
                                const h = (n.element.offsetHeight || 120) * targetScale;
                                const startY = target.top + 35 + (h / 2);
                                
                                ty = startY + (idx * 20); // 20px overlap
                            } else {
                                // Date exists but not in current month view -> Hide offscreen
                                tx = -500; ty = -500; targetScale = 0;
                            }
                        }

                        n.x += (tx - n.x) * 0.2;
                        n.y += (ty - n.y) * 0.2;
                    }
                    else if (p.physics) {
                        n.vx += (window.innerWidth/2 - n.x) * GRAVITY; n.vy += (window.innerHeight/2 - n.y) * GRAVITY;
                        thoughts.forEach((other, j) => {
                            if (i === j) return;
                            const dx = n.x - other.x, dy = n.y - other.y, distSq = dx*dx + dy*dy || 0.1, d = Math.sqrt(distSq);
                            const force = Math.min(REPULSION / distSq, 20); n.vx += (dx / d) * force; n.vy += (dy / d) * force;
                            if (n.tags.some(t => other.tags.includes(t)) && n.tags.length > 0) {
                                n.vx -= dx * ATTRACTION; n.vy -= dy * ATTRACTION;
                                ctx.beginPath(); ctx.moveTo(n.x, n.y); ctx.lineTo(other.x, other.y); ctx.strokeStyle = 'rgba(99, 102, 241, 0.15)'; ctx.stroke();
                            }
                        });
                        n.vx *= DAMPING; n.vy *= DAMPING; n.x += n.vx; n.y += n.vy;
                    }
                }
                
                // Smooth Scale
                n.scale += (targetScale - n.scale) * 0.1;
                
                n.element.style.transform = `translate3d(${n.x - 140}px, ${n.y - ((n.element.offsetHeight || 120)/2)}px, 0) scale(${n.scale})`;
            });
            requestAnimationFrame(loop);
        }

        let painting = false;
        // Paint Settings
        pCtx.lineCap = 'round';
        pCtx.lineJoin = 'round';
        
        pCanvas.onmousedown = (e) => { 
            painting = true; 
            pCtx.beginPath(); 
            pCtx.moveTo(e.offsetX, e.offsetY); 
            // Neon Chalk Style
            pCtx.strokeStyle = "#ffffff"; 
            pCtx.lineWidth = 4; // Thicker for calendar visibility
            pCtx.shadowBlur = 2;
            pCtx.shadowColor = "rgba(255, 255, 255, 0.5)";
        };
        pCanvas.onmousemove = (e) => { 
            if(painting) { 
                pCtx.lineTo(e.offsetX, e.offsetY); 
                pCtx.stroke(); 
            }
        };
        window.addEventListener('mouseup', () => { if(painting) { painting = false; selectedThought.drawing = pCanvas.toDataURL(); selectedThought.updateDOM(); save(); }});
        function clearPaint() { pCtx.clearRect(0,0,240,160); selectedThought.drawing = null; selectedThought.updateDOM(); save(); }

        function refreshIcons() { if(typeof lucide !== 'undefined') lucide.createIcons(); }
        function toggleView() { 
            const p = projects.find(p => p.id === activeProjectId); 
            if (p.mode === 'spatial') p.mode = 'kanban';
            else if (p.mode === 'kanban') p.mode = 'calendar';
            else p.mode = 'spatial';
            loadProject(activeProjectId); save(); 
            checkEmptyState();
        }
        function exportData() { const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([JSON.stringify(projects)])); a.download = 'thoughtist_backup.json'; a.click(); }
        function togglePhysics() { const p = projects.find(x => x.id === activeProjectId); p.physics = !p.physics; updatePhysBtn(); save(); }
        function updatePhysBtn() { const p = projects.find(x => x.id === activeProjectId); document.getElementById('phys-status').innerText = p.physics ? "Physics On" : "Physics Off"; document.getElementById('phys-btn').className = p.physics ? "text-indigo-400 flex items-center gap-2" : "text-slate-600 flex items-center gap-2"; refreshIcons(); }
        function toggleProjectMenu() { document.getElementById('project-menu').classList.toggle('opacity-0'); document.getElementById('project-menu').classList.toggle('pointer-events-none'); refreshIcons(); }
        function moveProject(dir) { const idx = projects.findIndex(x => x.id === activeProjectId); const t = idx + dir; if (t >= 0 && t < projects.length) { [projects[idx], projects[t]] = [projects[t], projects[idx]]; save(); renderTabs(); }}
        function renderTabs() { document.getElementById('project-tabs').innerHTML = projects.map(p => `<button onclick="loadProject('${p.id}')" class="tab-btn px-4 py-2 rounded-xl text-[10px] uppercase font-black flex-shrink-0 ${p.id === activeProjectId ? 'active-tab' : 'text-slate-500 hover:text-white hover:bg-white/5'}">${p.name}</button>`).join(''); document.getElementById('proj-slots').innerText = projects.length; }

        document.getElementById('edit-name').oninput = (e) => { selectedThought.text = e.target.value; selectedThought.updateDOM(); save(); };
        document.getElementById('edit-desc').oninput = (e) => { selectedThought.description = e.target.value; selectedThought.updateDOM(); save(); };
        document.getElementById('edit-content').oninput = (e) => { selectedThought.content = e.target.value; selectedThought.updateDOM(); save(); };
        document.getElementById('edit-date').onchange = (e) => { selectedThought.date = e.target.value; selectedThought.updateDOM(); save(); };
        document.getElementById('tag-input').onkeydown = (e) => { if ((e.key === 'Enter' || e.key === ',') && e.target.value.trim()) { e.preventDefault(); const v = e.target.value.trim().replace(',',''); if(!selectedThought.tags.includes(v)) selectedThought.tags.push(v); e.target.value=""; selectedThought.renderTags(); selectedThought.updateDOM(); save(); }};
        function closeInspector() { document.getElementById('inspector').classList.add('hidden'); selectedThought = null; }
        function updateStats() { 
            document.getElementById('node-count').innerText = thoughts.length; 
            checkEmptyState();
        }
        function checkEmptyState() {
            const p = projects.find(x => x.id === activeProjectId);
            const guide = document.getElementById('empty-guide');
            if (thoughts.length === 0 && p.mode === 'spatial') {
                guide.style.opacity = '1';
            } else {
                guide.style.opacity = '0';
            }
        }
        document.getElementById('import-input').onchange = (e) => { 
            const r = new FileReader(); 
            r.onload = (ev) => { 
                try {
                    const data = JSON.parse(ev.target.result); 
                    if(Array.isArray(data)) {
                        localStorage.setItem(KEY, JSON.stringify(data)); 
                        location.reload(); 
                    } else { alert("Invalid backup file."); }
                } catch(e) { alert("Error parsing file."); }
            }; 
            r.readAsText(e.target.files[0]); 
        };

        window.onload = () => { canvas.width = 5000; canvas.height = 5000; loadProject(activeProjectId); requestAnimationFrame(loop); };
    </script>
</body>
</html>